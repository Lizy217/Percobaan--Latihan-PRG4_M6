<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Daftar Transaksi</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
            crossorigin="anonymous"
        />
        <style>
            body {
                background-color: #f8f9fa;
                font-family: "Tahoma", sans-serif;
                padding: 20px;
            }
            .container {
                margin-top: 30px;
            }

            .table-container {
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                border-radius: 10px;
                background-color: white;
                padding: 20px;
            }

            h1 {
                text-align: center;
                margin-bottom: 30px;
            }

            .table thead th {
                background-color: #343a40;
                color: white;
            }

            .status-selesai {
                color: #198754;
                font-weight: bold;
            }

            .status-pending {
                color: #ffc107;
                font-weight: bold;
            }

            /* Form container disembunyikan secara default */
            #formContainer {
                display: none;
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                border-radius: 10px;
                background-color: white;
                padding: 20px;
                margin-top: 20px;
            }

            .loading {
                text-align: center;
                padding: 20px;
                color: #6c757d;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="table-container">
                <h1>Daftar Transaksi</h1>
                <button id="addDataBtn" class="btn btn-primary mb-3">+ Add Data</button>
                <table id="product-table" class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>ID Transaksi</th>
                            <th>Tanggal Transaksi</th>
                            <th>ID Produk</th>
                            <th>Jumlah</th>
                            <th>Total Harga</th>
                            <th>Status Transaksi</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="loading">Memuat data transaksi...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="formContainer" class="form-container">
            <h3 id="formTitle">Tambah Transaksi Baru</h3>
            <form id="addTransaksi">
                <div class="mb-3">
                    <label for="tanggal_transaksi" class="form-label">Tanggal Transaksi</label>
                    <input type="date" class="form-control" id="tanggal_transaksi" required />
                </div>
                <div class="mb-3">
                    <label for="id_produk" class="form-label">ID Produk</label>
                    <select class="form-control" id="id_produk" required>
                        <option value="">-- Loading Produk... --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="jumlah" class="form-label">Jumlah</label>
                    <input type="number" class="form-control" id="jumlah" required min="1" />
                </div>
                <div class="mb-3">
                    <label for="total_harga" class="form-label">Total Harga</label>
                    <input type="number" class="form-control" id="total_harga" required min="0" />
                </div>
                <div class="mb-3">
                    <label for="status_transaksi" class="form-label">Status</label>
                    <select class="form-control" id="status_transaksi" required>
                        <option value="Selesai">Selesai</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" id="submitBtn">Submit</button>
                <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
            </form>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
            integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
            crossorigin="anonymous"
        ></script>

        <script>
            // --- URL API ---
            const readUrl = "https://api.roniprsty.com/transaksi/read.php";
            const createUrl = "https://api.roniprsty.com/transaksi/create.php";
            const productReadUrl = "https://api.roniprsty.com/produk/read.php";
            const updateUrl = "https://api.roniprsty.com/transaksi/update.php";
            const deleteUrl = "https://api.roniprsty.com/transaksi/delete.php";

            // --- Variabel Global ---
            let currentEditId = null;

            // Fungsi untuk mengambil data transaksi
            async function getProducts() {
                let tableBody = document.querySelector("#product-table tbody");
                tableBody.innerHTML = '<tr><td colspan="7" class="loading">Memuat data transaksi...</td></tr>';

                try {
                    let response = await fetch(readUrl);

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    let transactions = await response.json();
                    tableBody.innerHTML = "";

                    // Asumsi struktur API bisa berupa {data: [...]} atau langsung [...]
                    const dataTransaksi = transactions.data ? transactions.data : Array.isArray(transactions) ? transactions : [];

                    if (!Array.isArray(dataTransaksi) || dataTransaksi.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data transaksi.</td></tr>';
                        return;
                    }

                    dataTransaksi.forEach((tx) => {
                        const statusClass = tx.status_transaksi === "Selesai" ? "status-selesai" : "status-pending";
                        let row = `
                             <tr>
                                 <td>${tx.id_transaksi || "-"}</td>
                                 <td>${tx.tanggal_transaksi || "-"}</td>
                                 <td>${tx.id_produk || "-"}</td>
                                 <td>${tx.jumlah || "-"}</td>
                                 <td>${tx.total_harga ? "Rp " + parseInt(tx.total_harga).toLocaleString("id-ID") : "-"}</td>
                                 <td class="${statusClass}">${tx.status_transaksi || "-"}</td>
                                 <td>
                                     <button class="btn btn-warning btn-sm" onclick="editTransaksi(${tx.id_transaksi})"> Edit</button>
                                     <button class="btn btn-danger btn-sm" onclick="deleteTransaksi(${tx.id_transaksi})"> Delete</button>
                                 </td>
                             </tr>
                             `;
                        tableBody.innerHTML += row;
                    });
                } catch (error) {
                    console.error("Gagal mengambil data transaksi:", error);
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Error saat memuat data. Periksa koneksi atau API URL.</td></tr>';
                }
            }

            // Handler tombol Add Data
            document.getElementById("addDataBtn").addEventListener("click", function () {
                document.getElementById("formTitle").textContent = "Tambah Transaksi Baru";
                document.getElementById("submitBtn").textContent = "Submit";
                document.getElementById("addTransaksi").reset();
                document.getElementById("formContainer").style.display = "block";

                // Pastikan semua field aktif saat mode 'Add Data'
                document.getElementById("tanggal_transaksi").disabled = false;
                document.getElementById("id_produk").disabled = false;
                document.getElementById("jumlah").disabled = false;
                document.getElementById("total_harga").disabled = false;
                document.getElementById("status_transaksi").disabled = false;
                currentEditId = null; // Reset ID edit

                // Muat daftar produk
                fetchProductIds();
            });

            // Handler tombol Cancel
            document.getElementById("cancelBtn").addEventListener("click", function () {
                document.getElementById("formContainer").style.display = "none";
                document.getElementById("addTransaksi").reset();
                currentEditId = null; // Reset ID edit

                // Aktifkan kembali field setelah cancel
                document.getElementById("tanggal_transaksi").disabled = false;
                document.getElementById("id_produk").disabled = false;
                document.getElementById("jumlah").disabled = false;
                document.getElementById("total_harga").disabled = false;
                document.getElementById("status_transaksi").disabled = false;
            });

            // Submit form (Create atau Update)
            document.getElementById("addTransaksi").addEventListener("submit", async function (e) {
                e.preventDefault();

                const status = document.getElementById("status_transaksi").value;
                const isUpdating = currentEditId !== null;
                let response;

                try {
                    if (isUpdating) {
                        // --- LOGIKA UPDATE (Hanya Status yang diubah) ---
                        const TransaksiData = {
                            id_transaksi: currentEditId,
                            status_transaksi: status,
                        };

                        console.log("Data yang dikirim untuk update:", TransaksiData);

                        response = await fetch(updateUrl, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(TransaksiData),
                        });

                        const responseData = await response.json();

                        if (!response.ok) {
                            throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
                        }

                        alert("Status Transaksi Berhasil diperbarui");
                        console.log("Response sukses:", responseData);
                    } else {
                        // --- LOGIKA CREATE (Semua field digunakan) ---
                        const tanggal = document.getElementById("tanggal_transaksi").value;
                        const idProduk = document.getElementById("id_produk").value;
                        const jumlah = document.getElementById("jumlah").value;
                        const totalHarga = document.getElementById("total_harga").value;

                        const TransaksiData = {
                            tanggal_transaksi: tanggal,
                            id_produk: idProduk,
                            jumlah: parseInt(jumlah),
                            total_harga: parseInt(totalHarga),
                            status_transaksi: status,
                        };

                        console.log("Data yang dikirim untuk create:", TransaksiData);

                        response = await fetch(createUrl, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(TransaksiData),
                        });

                        const responseData = await response.json();

                        if (!response.ok) {
                            throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
                        }

                        alert("Transaksi Berhasil ditambahkan");
                        console.log("Response sukses:", responseData);
                    }

                    // --- Logika Setelah Sukses Create/Update ---
                    getProducts();
                    document.getElementById("formContainer").style.display = "none";
                    this.reset();
                    currentEditId = null;

                    // Aktifkan kembali semua field form
                    document.getElementById("tanggal_transaksi").disabled = false;
                    document.getElementById("id_produk").disabled = false;
                    document.getElementById("jumlah").disabled = false;
                    document.getElementById("total_harga").disabled = false;
                    document.getElementById("status_transaksi").disabled = false;
                } catch (error) {
                    console.error(`Gagal ${isUpdating ? "Mengupdate" : "Menambahkan"} Transaksi:`, error);

                    // Tampilkan error yang lebih spesifik
                    let errorMessage = `Gagal ${isUpdating ? "mengupdate" : "menambahkan"} transaksi: ${error.message}`;

                    // Jika ada response, coba dapatkan detail error dari body response
                    if (response) {
                        try {
                            const errorResult = await response.json();
                            errorMessage = errorResult.message || errorMessage;
                        } catch (jsonError) {
                            // Jika gagal parse JSON, gunakan status text
                            errorMessage = `Error ${response.status}: ${response.statusText}`;
                        }
                    }

                    alert(errorMessage);
                }
            });

            // Fungsi: Mengambil daftar ID Produk dan mengisinya ke Select
            async function fetchProductIds() {
                const selectElement = document.getElementById("id_produk");
                selectElement.innerHTML = '<option value="">-- Loading Produk... --</option>'; // Pesan loading
                try {
                    let response = await fetch(productReadUrl);

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    let products = await response.json();
                    // Mengakomodasi struktur API: data berada di properti 'data' atau langsung array
                    const dataProduk = products.data ? products.data : Array.isArray(products) ? products : [];

                    selectElement.innerHTML = '<option value="">-- Pilih ID Produk --</option>'; // Reset opsi

                    if (!Array.isArray(dataProduk) || dataProduk.length === 0) {
                        selectElement.innerHTML = '<option value="">-- Tidak ada Produk --</option>';
                        return;
                    }

                    // Isi dropdown
                    dataProduk.forEach((product) => {
                        const option = document.createElement("option");
                        // Value diisi dengan ID produk
                        option.value = product.id;
                        // Teks yang ditampilkan ke pengguna (ID dan Nama Produk)
                        option.textContent = `ID ${product.id}: ${product.nama_produk || "Nama Tidak Tersedia"}`;
                        selectElement.appendChild(option);
                    });
                } catch (error) {
                    console.error("Gagal mengambil daftar produk:", error);
                    selectElement.innerHTML = '<option value="">-- Gagal memuat Produk --</option>';
                }
            }

            // Fungsi untuk mengedit transaksi
            async function editTransaksi(id_transaksi) {
                console.log("Edit transaksi dengan ID:", id_transaksi);

                currentEditId = id_transaksi;

                try {
                    // Gunakan read.php dan filter di client side
                    let response = await fetch(readUrl);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    let allTransactions = await response.json();

                    // Handle different API response structures
                    const transactions = allTransactions.data ? allTransactions.data : Array.isArray(allTransactions) ? allTransactions : [];

                    console.log("All transactions:", transactions);

                    // Cari transaksi dengan ID yang sesuai
                    const txData = transactions.find((tx) => tx.id_transaksi == id_transaksi);

                    if (!txData) {
                        throw new Error(`Transaksi dengan ID ${id_transaksi} tidak ditemukan`);
                    }

                    console.log("Data transaksi ditemukan:", txData);

                    // Isi form dengan data yang ditemukan
                    document.getElementById("tanggal_transaksi").value = txData.tanggal_transaksi || "";
                    document.getElementById("id_produk").value = txData.id_produk || "";
                    document.getElementById("jumlah").value = txData.jumlah || "";
                    document.getElementById("total_harga").value = txData.total_harga || "";
                    document.getElementById("status_transaksi").value = txData.status_transaksi || "Pending";

                    document.getElementById("formTitle").textContent = "Update Status Transaksi";
                    document.getElementById("submitBtn").textContent = "Update Status";

                    // Disable field kecuali status
                    document.getElementById("tanggal_transaksi").disabled = true;
                    document.getElementById("id_produk").disabled = true;
                    document.getElementById("jumlah").disabled = true;
                    document.getElementById("total_harga").disabled = true;
                    document.getElementById("status_transaksi").disabled = false;

                    document.getElementById("formContainer").style.display = "block";
                } catch (error) {
                    console.error("Gagal mengambil data Transaksi:", error);
                    alert(`Error: ${error.message}`);
                    currentEditId = null;
                }
            }
            // Fungsi untuk menghapus transaksi
            async function deleteTransaksi(id_transaksi) {
                if (confirm("Apakah Anda yakin ingin menghapus produk ini?")) {
                    try {
                        let response = await fetch(`${deleteUrl}?id=${id_transaksi}`, {
                            method: "DELETE",
                        });

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                        alert("Produk berhasil dihapus!");
                        getProducts(); // Muat ulang data produk
                    } catch (error) {
                        console.error("Gagal menghapus produk:", error);
                        alert("Gagal menghapus produk.");
                    }
                }
            }

            // Panggil fungsi untuk memuat data transaksi saat halaman dimuat
            document.addEventListener("DOMContentLoaded", function () {
                getProducts();
            });
        </script>
    </body>
</html>
