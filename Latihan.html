<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Daftar Transaksi</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
            crossorigin="anonymous"
        />
        <style>
            body {
                background-color: #f8f9fa;
                font-family: "Tahoma", sans-serif;
                padding: 20px;
            }
            .container {
                margin-top: 30px;
            }

            .table-container {
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                border-radius: 10px;
                background-color: white;
                padding: 20px;
            }

            h1 {
                text-align: center;
                margin-bottom: 30px;
            }

            .table thead th {
                background-color: #343a40;
                color: white;
            }
            /* Form container disembunyikan secara default, menggunakan CSS dari kode sebelumnya */
            #formContainer {
                display: none;
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                border-radius: 10px;
                background-color: white;
                padding: 20px;
                margin-top: 20px;
            }
        </style>
    </head>
       
    <body>
        <div class="container">
            <div class="table-container">
                <h1>Daftar Transaksi</h1>
                <button id="addDataBtn" class="btn btn-primary mb-3">+ Add Data</button>
                <table id="product-table" class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>ID Transaksi</th>
                            <th>Tanggal Transaksi</th>
                            <th>ID Produk</th>
                            <th>Jumlah</th>
                            <th>Total Harga</th>
                            <th>Status Transaksi</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center">Data Transaksi akan muncul di sini...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="formContainer" class="form-container">
            <h3 id="formTitle">Tambah Transaksi Baru</h3>
            <form id="addTransaksi">
                <div class="mb-3">
                    <label for="tanggal_transaksi" class="form-label">Tanggal Transaksi</label>
                    <input type="date" class="form-control" id="tanggal_transaksi" required />
                </div>
                <div class="mb-3">
                    <label for="id_produk" class="form-label">ID Produk</label>
                    <select class="form-control" id="id_produk" required>
                        <option value="">-- Pilih ID Produk --</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="jumlah" class="form-label">Jumlah</label>
                    <input type="number" class="form-control" id="jumlah" required />
                </div>
                <div class="mb-3">
                    <label for="total_harga" class="form-label">Total Harga</label>
                    <input type="number" class="form-control" id="total_harga" required />
                </div>
                <div class="mb-3">
                    <label for="status_transaksi" class="form-label">Status</label>
                    <select class="form-control" id="status_transaksi" required>
                        <option value="Selesai">Selesai</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" id="submitBtn">Submit</button>
                <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
            </form>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
            integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
            crossorigin="anonymous"
        ></script>

        <script>
            const readUrl = "https://api.roniprsty.com/transaksi/read.php";
            const createUrl = "https://api.roniprsty.com/transaksi/create.php";
            const productReadUrl = "https://api.roniprsty.com/produk/read.php";
            const UpdateUrl = "https://api.roniprsty.com/transaksi/update.php";

            // Fungsi untuk mengambil data transaksi
            async function getProducts() {
                let tableBody = document.querySelector("#product-table tbody");

                try {
                    let response = await fetch(readUrl);

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    let transactions = await response.json();
                    tableBody.innerHTML = "";

                    const dataTransaksi = transactions.data ? transactions.data : Array.isArray(transactions) ? transactions : [];

                    if (!Array.isArray(dataTransaksi) || dataTransaksi.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data transaksi.</td></tr>';
                        return;
                    }

                    dataTransaksi.forEach((tx) => {
                        let row = `
                        <tr>
                            <td>${tx.id_transaksi || "-"}</td>
                            <td>${tx.tanggal_transaksi || "-"}</td>
                            <td>${tx.id_produk || "-"}</td>
                            <td>${tx.jumlah || "-"}</td>
                            <td>${tx.total_harga || "-"}</td>
                            <td>${tx.status_transaksi || "-"}</td>

                            <td>
                                <button class="btn btn-warning btn-sm" onclick="editProduct(${tx.id_transaksi})"> Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${tx.id_transaksi})"> Delete</button>
                            </td> 

                        </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } catch (error) {
                    console.error("Gagal mengambil data transaksi:", error);
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Error saat memuat data. Periksa koneksi atau API URL.</td></tr>';
                }
                fetchProductIds();
            }

            //  Tombol Add Data
            document.getElementById("addDataBtn").addEventListener("click", function () {
                document.getElementById("formTitle").textContent = "Tambah Transaksi Baru";
                document.getElementById("submitBtn").textContent = "Submit";
                document.getElementById("addTransaksi").reset();
                document.getElementById("formContainer").style.display = "block";
            });

            // Tombol Cancel
            document.getElementById("cancelBtn").addEventListener("click", function () {
                document.getElementById("formContainer").style.display = "none";
                document.getElementById("addTransaksi").reset();
            });

            //Submit form
            document.getElementById("addTransaksi").addEventListener("submit", async function (e) {
                e.preventDefault();

                // Ambil nilai dari form (Menggunakan ID yang benar dan variabel yang konsisten)
                const tanggal = document.getElementById("tanggal_transaksi").value;
                const idProduk = document.getElementById("id_produk").value;
                const jumlah = document.getElementById("jumlah").value;
                const totalHarga = document.getElementById("total_harga").value;
                const status = document.getElementById("status_transaksi").value;

                // Objek data yang dikirim ke API (Sesuai dengan kolom Transaksi)
                const TransaksiData = {
                    tanggal_transaksi: tanggal,
                    id_produk: idProduk,
                    jumlah: jumlah,
                    total_harga: totalHarga,
                    status_transaksi: status,
                };

                try {
                    if (id) {
                        // update produk yang ada
                        productData.id = id; //tambahkan id produk
                        let response = await fetch(UpdateUrl, {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(productData),
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        alert("Transaksi Berhasil diperbarui");
                    } else {
                        //tambah produk baru
                        let response = await fetch(createUrl, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(productData),
                        });
                        alert("Produk Berhasil ditambahkan");
                    }

                    if (!response.ok) {
                        const errorResult = await response.json().catch(() => ({ message: `Error ${response.status}` }));
                        throw new Error(errorResult.message || `HTTP error! Status: ${response.status}`);
                    }

                    const successResult = await response.json();

                    // Perbarui tampilan
                    getProducts();
                    document.getElementById("formContainer").style.display = "none";
                    this.reset();
                } catch (error) {
                    console.error("Gagal Menambahkan Transaksi:", error);
                    alert(`Gagal menambahkan transaksi: ${error.message || "Cek console log."}`);
                }
            });

            // Fungsi BARU: Mengambil daftar ID Produk dan mengisinya ke Select
            async function fetchProductIds() {
                const selectElement = document.getElementById("id_produk");
                selectElement.innerHTML = '<option value="">-- Loading Produk... --</option>'; // Pesan loading

                try {
                    let response = await fetch(productReadUrl);

                    // Memastikan response OK dan mendapatkan data JSON
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    let products = await response.json();
                    // Mengakomodasi struktur API: data berada di properti 'data' atau langsung array
                    const dataProduk = products.data ? products.data : Array.isArray(products) ? products : [];

                    selectElement.innerHTML = '<option value="">-- Pilih ID Produk --</option>'; // Reset opsi

                    if (!Array.isArray(dataProduk) || dataProduk.length === 0) {
                        selectElement.innerHTML = '<option value="">-- Tidak ada Produk --</option>';
                        return;
                    }

                    // Isi dropdown
                    dataProduk.forEach((product) => {
                        const option = document.createElement("option");
                        // Value diisi dengan ID produk
                        option.value = product.id;
                        // Teks yang ditampilkan ke pengguna (ID dan Nama Produk)
                        option.textContent = `ID ${product.id}: ${product.nama_produk || "Nama Tidak Tersedia"}`;
                        selectElement.appendChild(option);
                    });
                } catch (error) {
                    console.error("Gagal mengambil daftar produk:", error);
                    selectElement.innerHTML = '<option value="">-- Gagal memuat Produk --</option>';
                }
            }

            // Fungsi untuk mengedit produk
            async function editTransaksi(id) {
                try {
                    let response = await fetch(UpdateUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    let product = await response.json();

                    // // Periksa apakah data produk diterima dengan benar
                    // if (!product || !product.nama_produk) {
                    //     throw new Error("Data produk tidak ditemukan atau struktur data salah");
                    // }

                    // Isi form dengan data produk
                    document.getElementById("tanggal_transaksi").value = product.tanggal_transaksi;
                    const idProduk = document.getElementById("id_produk").value;
                    const jumlah = document.getElementById("jumlah").value;
                    const totalHarga = document.getElementById("total_harga").value;
                    const status = document.getElementById("status_transaksi").value;

                    // Ubah judul form dan tombol submit untuk mode edit
                    document.getElementById("formTitle").textContent = "Update Data Transaksi";
                    document.getElementById("submitBtn").textContent = "Update";

                    // Simpan ID Produk ke dalam dataset form
                    document.getElementById("addTransaksi").dataset.id = product.id;

                    // Tampilkan form
                    document.getElementById("formContainer").style.display = "block";
                } catch (error) {
                    console.error("Gagal mengambil data Transaksi:", error);
                    alert("Terjadi kesalahan saat mengambil data Transaksi, silakan coba lagi.");
                }
            }

            // Panggil fungsi untuk memuat data transaksi saat halaman dimuat
            getProducts();
        </script>
    </body>
</html>
